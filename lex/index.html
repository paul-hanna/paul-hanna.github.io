<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>lex</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }
        img {
            max-width: 300px;
            height: 250px;
            object-fit: cover;
            border: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div id="gallery"></div>
    <script>
        // ====== CONFIGURATION ======
        // Column mapping (0-indexed, adjust based on your form structure)
        const COLUMNS = {
            timestamp: 0,    // Assuming Timestamp is first column
            imageUrl: 1,     // Assuming Image URL is second column
            // title: 2      // Title is no longer displayed in this raw version
        };

        // Auto-refresh interval in seconds (set to 0 to disable)
        const AUTO_REFRESH = 30;
        // ===========================

        class ImageGallery {
            constructor() {
                this.gallery = document.getElementById('gallery');
                console.log("ImageGallery initialized."); // Log
                this.loadImages();

                if (AUTO_REFRESH > 0) {
                    setInterval(() => this.loadImages(), AUTO_REFRESH * 1000);
                }
            }

            async loadImages() {
                try {
                    // Use the full URL generated by Google's "Publish to web" feature
                    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSq5u3NLzwualGtdcLOKo1C6mHCMYjdaY79ExgbVvnQsHqoi8vZ3mOBJiC1bojznkmC1vLwWuQp3lg4/pub?gid=272625126&single=true&output=csv';
                    console.log("Attempting to fetch CSV from:", csvUrl); // Log
                    const response = await fetch(csvUrl);

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status} when fetching CSV`);
                    }
                    const csvText = await response.text();
                    console.log("CSV fetched successfully. First 200 chars:", csvText.substring(0, 200) + '...'); // Log

                    // The problematic line from your error report:
                    const rows = this.parseCSV(csvText); // Calling the parseCSV method

                    if (rows.length > 1) {
                        this.displayImages(rows.slice(1)); // Skip header row
                    } else {
                        this.gallery.innerHTML = 'No images found.';
                    }

                } catch (error) {
                    console.error('Error loading images:', error); // Log full error
                    this.gallery.innerHTML = 'Error loading images.';
                }
            }

            // This method MUST be defined inside the class body {}
            parseCSV(csv) {
                const lines = csv.trim().split('\n');
                return lines.map(line => {
                    const result = [];
                    let current = '';
                    let inQuotes = false;

                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];

                        // Handle escaped quotes within a field ("" becomes ")
                        if (char === '"' && inQuotes && line[i + 1] === '"') {
                            current += '"';
                            i++; // Skip the next quote
                        } else if (char === '"') {
                            inQuotes = !inQuotes; // Toggle quote state
                        } else if (char === ',' && !inQuotes) {
                            result.push(current); // End of field
                            current = '';
                        } else {
                            current += char; // Append character to current field
                        }
                    }
                    result.push(current); // Push the last field
                    return result;
                });
            }

            displayImages(rows) {
                this.gallery.innerHTML = ''; // Clear previous content

                rows.forEach((row, rowIndex) => { // Added rowIndex for logging
                    console.log(`Processing row ${rowIndex}:`, row); // Log
                    const rawCellValue = row[COLUMNS.imageUrl];
                    const imageUrl = this.getImageUrl(rawCellValue);

                    console.log(`Row ${rowIndex} - Raw Cell Value for Image URL:`, rawCellValue); // Log
                    console.log(`Row ${rowIndex} - Processed Image URL from getImageUrl:`, imageUrl); // Log

                    if (imageUrl) {
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = 'Uploaded Image';
                        img.loading = 'lazy';
                        // IMPORTANT: We've changed onerror to log and show a dashed border, NOT hide!
                        img.onerror = () => {
                            console.error('Failed to load image:', img.src); // Use console.error for errors
                            img.style.border = '2px dashed red'; // Make the broken image obvious
                            img.alt = 'Broken Image - Check permissions';
                        };
                        this.gallery.appendChild(img);
                    } else {
                        console.warn(`Skipping image for row ${rowIndex} due to invalid or missing URL.`); // Log
                    }
                });
            }

            getImageUrl(cellValue) {
                console.log("getImageUrl called with:", cellValue); // Log
                if (!cellValue || typeof cellValue !== 'string' || !cellValue.includes('drive.google.com')) {
                    console.warn('getImageUrl: Invalid or non-Drive URL received:', cellValue);
                    return null;
                }

                // Try to match the /d/FILE_ID/view format (for direct Drive links)
                let fileIdMatch = cellValue.match(/\/d\/([a-zA-Z0-9-_]+)/);

                if (!fileIdMatch) {
                    // If not found, try to match the /open?id=FILE_ID format (common for form uploads)
                    // or the uc?export=view&id=FILE_ID format (what your Apps Script produces)
                    fileIdMatch = cellValue.match(/id=([a-zA-Z0-9-_]+)/);
                }

                const fileId = fileIdMatch ? fileIdMatch[1] : null;
                console.log("File ID extracted by getImageUrl:", fileId); // Log

                // Return the formatted uc?export=view URL using the extracted fileId
                const finalUrl = fileId ? `https://drive.google.com/uc?export=view&id=${fileId}` : null;
                console.log("Final URL constructed by getImageUrl:", finalUrl); // Log
                return finalUrl;
            }
        }

        // Initialize gallery when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ImageGallery();
        });
    </script>
</body>
</html>